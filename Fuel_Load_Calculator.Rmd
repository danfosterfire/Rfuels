---
title: "Fuel_Load_Calculator_DroughtMortality"
author: "Danny Foster"
date: "November 16, 2017"
output: html_document
---

**ABOUT:**

This file includes code and supporting documentation for a method to calculate total fuel loads from Brown's transects for Sierra Nevada tree species. This method was originally developed by Jason Moghaddas and Scott Stephens, and relies on the work of many others (see documentation). The purpose of this document is to implement the method in R for improved usability, repeatability, and clarity. The R implementation of this project was developed by Danny Foster in 2017.

will wind up sharing the package by instructing the user to use devtools::install_github(url)
at least until/unless i get this on CRAN

#The Script

##USERS: EDIT THESE VALUES

The script will work out of the box as long as these values are correctly set and the input data are valid. See "Import and check data" for descriptions of proper formatting for the input data.

```{r}
# Default values will use the example data included with this script.
setwd('D://Foster/FFS/Fuels_for_Kuskulis') # v2 has '~FFS/fuel_transect_analyzer

# all files must be in csv format, and all filenames should include the '.csv' suffix

# v2 references the example_fuels.csv etc files
fuels_data_source = 'fuels_processed.csv' 

trees_data_source = 'treelist_processed.csv'

full_output_filename = 'Drought_Mortality_fuel_loads_full.csv'

results_output_filename = 'Drought_Mortality_fuel_loads_results.csv'

#The user must also define the transect lengths for each size class, in meters. **Keep in mind that if sampling protocol changed from one year to the next (e.g. crews used 6-foot transects one year and 2-meter transects the next), you must edit the transect lengths for specific rows.** (See code under "Calculate Fuel Loads Using Coefficients.")

# v2 indicates transect lengths = 1.83

x1h_transect_length = 2

x10h_transect_length = 2

x100h_transect_length = 3

x1000h_transect_length = 12.62



```

Users may wish to modify some portion of the code below to better suit their data. In particular: 

**users with transect-level information on slope should see the section "Calculate Slope Correction Factor"**

**If tansect lengths are not consistent across the entire dataset, users should refer to the section "Incorporate Transect Lengths"**


##Setup

###Building Constant Tables

Tables are copied from the relevant literature: Van Wagtendonk et al. (1996), Van Wagtendonk et al. (1998), and Van Wagner (1982)

```{r}


```

###Install and/or import required packages

```{r}

# INSTALL OR LOAD PACKAGES
#install.packages('reshape2')
#install.packages('lubridate')

library(reshape2)
library(lubridate)

```

###Import and Check Data

Data import and validity testing

####Fuels Transects




```{r}
# import the csv data
fuels.measurements = read.csv(fuels_data_source)

# examine the imported dataframe
head(fuels.measurements)


# validate classes for columns

## 'inv_date' should be a lubridate Date object
fuels.measurements['inv_date'] = as.Date(fuels.measurements$inv_date, '%m/%d/%Y')


#

```


####Overstory Data

To describe the overstory for each plot location, provide a treelist. Each row in the treelist identifies the measurements (species and DBH) of an individual tree within a (plot_id:inv_date).

At a minimum, the treelist must include columns for:

**plot_id**: A unique plot identifier matching the fuels measurements.

**inv_date**: the date of measurement. There must be a 1:1 match between the dates of fuels measurements and the dates of the treelist measurements. (plot_id:inv_date) must uniquely identify a measurement in both the fuels and the trees data.  

**species**: A species identifier code for the individual tree. Must be in four-letter scientific format (e.g. "ABCO", not "WF", "White fir", "Abies concolor", etc.) Compare your species codes to those included in the Van Wagner constant tables to ensure correct matching.

Note that singleleaf pinyon (*Pinus monophylla*) and western white pine (*Pinus monticola*) would share the code "PIMO": These should be labeled "PIMO1" and "PIMO2", respectively.

**dbh**: The diameter of the tree in centimeters.


```{r}
trees.measurements = read.csv(trees_data_source)

head(trees.measurements)

# validate classes for columns
trees.measurements['inv_date'] = as.Date(trees.measurements$inv_date, '%m/%d/%Y')

# Re-label species not included in the Van Wagtendonk tables as 'OTHER' to ensure proper processing

## first, convert the SPECIES column from factor to string

trees.measurements['species'] = as.character(trees.measurements[,'species'])

## second, convert any species not included in both the van wagtendonk tables to 'OTHER'
trees.measurements[!is.element(trees.measurements$species,vw96_spp_code)|
                   !is.element(trees.measurements$species,vw98_spp_code),
                 'species'] = 'OTHER'

## finally, convert species back to factor

trees.measurements['species'] = as.factor(trees.measurements[,'species'])

```

####Metadata

#####Define K-Value

The k-value is a unit-conversion constant. This script assumes users supply fuel diameters in cm, transect lengths in meters, and want to calculate fuel loads as metric tonnes / hectare. Using the kvals table, we set our specific k-value to 1.234 accordingly. This script has not been tested with other combinations of units, and it is strongly recommended that users convert all their data to these units before attempting to calculate fuel loads.

```{r}
k_value = 1.234
```




##Calculate Fuel Loads from Measurements

###Match Overstory Measurements to Fuels Measurements

####Using the treelist data, calculate the proportion of plot basal area occupied by each species

```{r}


```

####Merge overstory data to fuels transects

```{r}
combined_measurements = merge(overstory.wide,
                              fuels.measurements,
                              by=c('plot_id','inv_date'),
                              all.y=TRUE) # we may have multiple transects per overstory plot

head(combined_measurements)

```

###Calculate Fuel Measurement Coefficients Using Overstory Characteristics

####Setup

```{r}
# Each vector of coefficients has length equal to the number of rows in the combined measurements table
nrows = length(combined_measurements[,'plot_id'])

# The list of species included in the entire dataset
get_spp_codes = function(measurements){
  result = names(measurements)
  remove = c("plot_id","inv_date","azimuth","count_1h","count_10h","count_100h",
             "duff_depth","litter_depth","sum_d2_r","sum_d2_s","pBA_(all)")
  result = result[! result %in% remove]
  result = sapply(result, FUN=function(x){substring(x,5)}, USE.NAMES=FALSE)
  return(result)
}


species_list = get_spp_codes(combined_measurements)

species_list


lookup_vw = function(constants,species,value){
  return(constants[constants$'spp'==species,value])
}
```

####Litter and Duff Coefficients

```{r}
# Calculate coefficient for litter depth

weighted_litter_coeffs = numeric(nrows)

# for each row in the combined measurements table
for(i in 1:nrows){
  
  # the weighted aggregate coefficient starts at 0
  weighted_litter_coeff = 0
  
  # for each tree species included in the dataset
  for (spp in species_list){
    
    # look up the proportion of plot_id:inv_date basal area occupied by spp
    pba = combined_measurements[i, paste0('pBA_',spp)]
    
    # look up the coefficient given by Van Wagtendonk for litter of spp
    litter_coeff_spp = lookup_vw(litterduff_coeffs, spp, 'litter_coeff')
    
    # The weighted contribution to the overall coefficient is the proportion of basal area times the species coefficient
    litter_weighted_spp = litter_coeff_spp*pba
    
    # Include the weighted contribution of spp to the overall coefficient
    weighted_litter_coeff = weighted_litter_coeff+litter_weighted_spp
    
  }
  
  # the weighted coefficient for row i is the overall coefficient calculated from all species*basal areas:
  weighted_litter_coeffs[i] = weighted_litter_coeff
  
}

combined_measurements['litter_coeff'] = weighted_litter_coeffs


# calculate coefficient for duff depth

weighted_duff_coeffs = numeric(nrows)

# for each row in the combined measurements table
for(i in 1:nrows){
  
  # the weighted aggregate coefficient starts at 0
  weighted_duff_coeff = 0
  
  # for each tree species included in the dataset
  for (spp in species_list){
    
    # look up the proportion of plot_id:inv_date basal area occupied by spp
    pba = combined_measurements[i, paste0('pBA_',spp)]
    
    # look up the coefficient given by Van Wagtendonk for duff of spp
    duff_coeff_spp = lookup_vw(litterduff_coeffs, spp, 'duff_coeff')
    
    # The weighted contribution to the overall coefficient is the proportion of basal area times the species coefficient
    duff_weighted_spp = duff_coeff_spp*pba
    
    # Include the weighted contribution of spp to the overall coefficient
    weighted_duff_coeff = weighted_duff_coeff+duff_weighted_spp
    
  }
  
  # the weighted coefficient for row i is the overall coefficient calculated from all species*basal areas:
  weighted_duff_coeffs[i] = weighted_duff_coeff
  
}

combined_measurements['duff_coeff'] = weighted_duff_coeffs



```

####1-, 10-, and 100-hour coefficients

```{r}

head(QMDcm)

weighted_1h_coeffs = numeric(nrows)

# for each row in the combined measurements table
for(i in 1:nrows){
  
  # the weighted aggregate values for qmd, sec, and sg start at 0
  average_1h_qmd = 0
  average_1h_sec = 0
  average_1h_sg = 0
  
  # for each tree species included in the dataset
  for (spp in species_list){
    
    # look up the proportion of plot_id:inv_date basal area occupied by spp
    pba = combined_measurements[i, paste0('pBA_',spp)]
    
    # look up the average qmd of 1h fuels from spp
    qmd_spp = lookup_vw(QMDcm, spp, 'x1h')
    
    # The weighted contribution to the average qmd is the proportion of basal area times the species coefficient
    weighted_1h_qmd = qmd_spp*pba
    
    # Include the weighted contribution of spp to the overall coefficient
    average_1h_qmd = average_1h_qmd+weighted_1h_qmd
    
    # similar calculations for SEC and SG
    sec_spp = lookup_vw(SEC,spp, 'x1h')
    weighted_1h_sec = sec_spp*pba
    average_1h_sec = average_1h_sec+weighted_1h_sec
    
    sg_spp = lookup_vw(SG, spp, 'x1h')
    weighted_1h_sg = sg_spp*pba
    average_1h_sg = average_1h_sg+weighted_1h_sg
  }
  
  # the weighted coefficient for row i is the product of the species-weighted averages for QMD, SEC, and SG:
  weighted_1h_coeffs[i] = average_1h_qmd*average_1h_sec*average_1h_sg
  
}

combined_measurements['x1h_coeff'] = weighted_1h_coeffs

head(combined_measurements)


# calculate 10-hour coefficients

weighted_10h_coeffs = numeric(nrows)

# for each row in the combined measurements table
for(i in 1:nrows){
  
  # the weighted aggregate values for qmd, sec, and sg start at 0
  average_10h_qmd = 0
  average_10h_sec = 0
  average_10h_sg = 0
  
  # for each tree species included in the dataset
  for (spp in species_list){
    
    # look up the proportion of plot_id:inv_date basal area occupied by spp
    pba = combined_measurements[i, paste0('pBA_',spp)]
    
    # look up the average qmd of 10h fuels from spp
    qmd_spp = lookup_vw(QMDcm, spp, 'x10h')
    
    # The weighted contribution to the average qmd is the proportion of basal area times the species coefficient
    weighted_10h_qmd = qmd_spp*pba
    
    # Include the weighted contribution of spp to the overall coefficient
    average_10h_qmd = average_10h_qmd+weighted_10h_qmd
    
    # similar calculations for SEC and SG
    sec_spp = lookup_vw(SEC,spp, 'x10h')
    weighted_10h_sec = sec_spp*pba
    average_10h_sec = average_10h_sec+weighted_10h_sec
    
    sg_spp = lookup_vw(SG, spp, 'x10h')
    weighted_10h_sg = sg_spp*pba
    average_10h_sg = average_10h_sg+weighted_10h_sg
  }
  
  # the weighted coefficient for row i is the product of the species-weighted averages for QMD, SEC, and SG:
  weighted_10h_coeffs[i] = average_10h_qmd*average_10h_sec*average_10h_sg
  
}

combined_measurements['x10h_coeff'] = weighted_10h_coeffs

head(combined_measurements)


# Calculate 100-hour coefficients

weighted_100h_coeffs = numeric(nrows)

# for each row in the combined measurements table
for(i in 1:nrows){
  
  # the weighted aggregate values for qmd, sec, and sg start at 0
  average_100h_qmd = 0
  average_100h_sec = 0
  average_100h_sg = 0
  
  # for each tree species included in the dataset
  for (spp in species_list){
    
    # look up the proportion of plot_id:inv_date basal area occupied by spp
    pba = combined_measurements[i, paste0('pBA_',spp)]
    
    # look up the average qmd of 100h fuels from spp
    qmd_spp = lookup_vw(QMDcm, spp, 'x100h')
    
    # The weighted contribution to the average qmd is the proportion of basal area times the species coefficient
    weighted_100h_qmd = qmd_spp*pba
    
    # Include the weighted contribution of spp to the overall coefficient
    average_100h_qmd = average_100h_qmd+weighted_100h_qmd
    
    # similar calculations for SEC and SG
    sec_spp = lookup_vw(SEC,spp, 'x100h')
    weighted_100h_sec = sec_spp*pba
    average_100h_sec = average_100h_sec+weighted_100h_sec
    
    sg_spp = lookup_vw(SG, spp, 'x100h')
    weighted_100h_sg = sg_spp*pba
    average_100h_sg = average_100h_sg+weighted_100h_sg
  }
  
  # the weighted coefficient for row i is the product of the species-weighted averages for QMD, SEC, and SG:
  weighted_100h_coeffs[i] = average_100h_qmd*average_100h_sec*average_100h_sg
  
}

combined_measurements['x100h_coeff'] = weighted_100h_coeffs


```

####1000-hour coefficients

```{r}
weighted_1000s_coeffs = numeric(nrows)

# for each row in the combined measurements table
for(i in 1:nrows){
  
  # the weighted aggregate values for sec, and sg start at 0
  average_1000s_sec = 0
  average_1000s_sg = 0
  
  # for each tree species included in the dataset
  for (spp in species_list){
    
    # look up the proportion of plot_id:inv_date basal area occupied by spp
    pba = combined_measurements[i, paste0('pBA_',spp)]
    
    # similar calculations for SEC and SG
    sec_spp = lookup_vw(SEC,spp, 'x1000h')
    weighted_1000s_sec = sec_spp*pba
    average_1000s_sec = average_1000s_sec+weighted_1000s_sec
    
    sg_spp = lookup_vw(SG, spp, 'x1000s')
    weighted_1000s_sg = sg_spp*pba
    average_1000s_sg = average_1000s_sg+weighted_1000s_sg
  }
  
  # the weighted coefficient for row i is the product of the species-weighted averages for QMD, SEC, and SG:
  weighted_1000s_coeffs[i] = average_1000s_sec*average_1000s_sg
  
}

combined_measurements['x1000s_coeff'] = weighted_1000s_coeffs

# calculate 1000-hour (rotten) coefficient

weighted_1000r_coeffs = numeric(nrows)

# for each row in the combined measurements table
for(i in 1:nrows){
  
  # the weighted aggregate values for sec starts at 0. SG for rotten fuels does not vary by species:
  average_1000r_sec = 0
  average_1000r_sg = 0.36
  
  # for each tree species included in the dataset
  for (spp in species_list){
    
    # look up the proportion of plot_id:inv_date basal area occupied by spp
    pba = combined_measurements[i, paste0('pBA_',spp)]
    
    # similar calculations for SEC
    sec_spp = lookup_vw(SEC,spp, 'x1000h')
    weighted_1000r_sec = sec_spp*pba
    average_1000r_sec = average_1000r_sec+weighted_1000r_sec
  }
  
  # the weighted coefficient for row i is the product of the species-weighted averages for QMD, SEC, and SG:
  weighted_1000r_coeffs[i] = average_1000r_sec*average_1000r_sg
  
}

combined_measurements['x1000r_coeff'] = weighted_1000r_coeffs




head(combined_measurements)



```

###Calculate Fuel Loads Using Coefficients and Transect Measurements

For an explanation of the equations used, see the "Documentation" section.

####Incorporate transect lengths

```{r}
# Apply the default values specified above

combined_measurements['x1h_L'] = x1h_transect_length
combined_measurements['x10h_L'] = x10h_transect_length
combined_measurements['x100h_L'] = x100h_transect_length
combined_measurements['x1000h_L'] = x1000h_transect_length

# Edit the transect lengths for specific subsets of the data as needed

# For example, in the example dataset the 2009 measurements actually used 2 meter transects, rather than 6 foot ones.
# I've commented out these lines so that the script assumes the default values for all years, but these lines are
# necessary to make the example data calculations accurate.
combined_measurements[year(combined_measurements$inv_date)==2009,'x1h_L'] = 2
combined_measurements[year(combined_measurements$inv_date)==2009, 'x10h_L'] = 2
combined_measurements[year(combined_measurements$inv_date)==2009, 'x100h_L'] = 3
combined_measurements[year(combined_measurements$inv_date)==2009, 'x1000h_L'] = 11.3

head(combined_measurements)

```

####Calculate Slope Correction Factor

Brown's equations include the option to correct for slope effect on horizontal length of transects. Keep in mind that for this correction factor to be accurate, you should be correcting for the *transect* slope, not the *plot* slope. By default, we set the slope correction factor to 1 (no slope). Users with transect-specific slopes may want to adjust this column accordingly. The equation for slope correction factor is:

$SLP = c = \sqrt{1+(\frac{percentslope}{100})^2}$ per Brown 1974.

```{r}

combined_measurements['slp_c'] = 1

```

####Calculate Litter and Duff Loads

```{r}
# load = depth(cm)* coeff * 10 (to convert from kg/m2 to mtons/ha)

combined_measurements['fuelload_litter_tonha'] = combined_measurements$litter_depth*combined_measurements$litter_coeff*10

combined_measurements['fuelload_duff_tonha'] = combined_measurements$duff_depth*combined_measurements$duff_coeff*10

```

####Calculate 1-through-100 hour fuel loads
```{r}

# load = ((coefficient)(n_intersections)(k-value)(slope correction factor))/(transect length)

combined_measurements['fuelload_1h_tonha'] = (combined_measurements$count_1h*
                                                combined_measurements$x1h_coeff*
                                                combined_measurements$slp_c*
                                                k_value) / (combined_measurements$x1h_L)

combined_measurements['fuelload_10h_tonha'] = (combined_measurements$count_10h*
                                                combined_measurements$x10h_coeff*
                                                combined_measurements$slp_c*
                                                k_value) / (combined_measurements$x10h_L)

combined_measurements['fuelload_100h_tonha'] = (combined_measurements$count_100h*
                                                combined_measurements$x100h_coeff*
                                                combined_measurements$slp_c*
                                                k_value) / (combined_measurements$x100h_L)


```


####Calculate 1000-hour fuel loads

```{r}
# load = (k-value)(slope correction factor)(coefficient)(sum squared dbhs) / (transect length)
combined_measurements['fuelload_1000s_tonha'] = (k_value*
                                                   combined_measurements$slp_c*
                                                   combined_measurements$x1000s_coeff*
                                                   combined_measurements$sum_d2_s) / (combined_measurements$x1000h_L)

combined_measurements['fuelload_1000r_tonha'] = (k_value*
                                                   combined_measurements$slp_c*
                                                   combined_measurements$x1000r_coeff*
                                                   combined_measurements$sum_d2_r) / (combined_measurements$x1000h_L)


```


####Calculate Aggregate Loads

```{r}
combined_measurements['fuelload_1000h_tonha']= combined_measurements$fuelload_1000s_tonha+
                                                combined_measurements$fuelload_1000r_tonha

combined_measurements['fuelload_surface_tonha' ] = combined_measurements$fuelload_litter_tonha+
                                                  combined_measurements$fuelload_1h_tonha+
                                                  combined_measurements$fuelload_10h_tonha+
                                                  combined_measurements$fuelload_100h_tonha+
                                                  combined_measurements$fuelload_1000s_tonha+
                                                  combined_measurements$fuelload_1000r_tonha

combined_measurements['fuelload_total_tonha' ] = combined_measurements$fuelload_duff_tonha+
                                                  combined_measurements$fuelload_litter_tonha+
                                                  combined_measurements$fuelload_1h_tonha+
                                                  combined_measurements$fuelload_10h_tonha+
                                                  combined_measurements$fuelload_100h_tonha+
                                                  combined_measurements$fuelload_1000s_tonha+
                                                  combined_measurements$fuelload_1000r_tonha
```


##Write Output Tables

```{r}
# the full output includes the actual measurement data as well as intermediate values
write.csv(combined_measurements, file=full_output_filename, row.names=FALSE)

# the results output table includes only the plot_id, inv_date, azimuth, and fuel loads
results_table = combined_measurements[,c('plot_id','inv_date','azimuth',
                                         'fuelload_litter_tonha','fuelload_duff_tonha',
                                         'fuelload_1h_tonha','fuelload_10h_tonha',
                                         'fuelload_100h_tonha','fuelload_1000h_tonha',
                                         'fuelload_1000s_tonha','fuelload_1000r_tonha',
                                         'fuelload_surface_tonha','fuelload_total_tonha')]

head(results_table)

write.csv(results_table, file=results_output_filename, row.names=FALSE)

```

Users may wish to aggregate results by plot, year, stand, experimental group, etc. in their preferred data-management software.


#Documentation

